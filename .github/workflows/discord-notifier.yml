name: Shared Discord Notifier
on:
  workflow_call:
    inputs:
      test_report_path:
        type: string
        default: 'test-results.xml'
      sonar_status:
        type: string
        default: 'N/A'
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: prepare
        shell: bash
        run: |
          # slice í•¨ìˆ˜ ëŒ€ì‹  bashì˜ cut ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ 100ì ìš”ì•½
          PR_BODY=$(cat << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          # ì¤„ë°”ê¿ˆ ì œê±° í›„ 100ì ì¶”ì¶œ
          SUMMARY=$(echo "$PR_BODY" | tr -d '\n' | cut -c 1-100)
          echo "summary=${SUMMARY}..." >> $GITHUB_OUTPUT
          
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± (ì¤‘ì•™ ì§‘ì¤‘)
          if [ -f "${{ inputs.test_report_path }}" ]; then
            TESTS=$(grep -oP 'tests="\K[^"]+' ${{ inputs.test_report_path }} | head -1 || echo "0")
            FAILS=$(grep -oP 'failures="\K[^"]+' ${{ inputs.test_report_path }} | head -1 || echo "0")
            echo "test_res=âœ… $((TESTS-FAILS)) / Total: $TESTS (âŒ Fail: $FAILS)" >> $GITHUB_OUTPUT
          else
            echo "test_res=âš ï¸ No Report" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord
        uses: appleboy/discord-action@master
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            ### ğŸš€ PR ì•Œë¦¼: ${{ github.event.pull_request.title }}
            **ìš”ì•½:** ${{ steps.prepare.outputs.summary }}
            
            ---
            - **í…ŒìŠ¤íŠ¸:** `${{ steps.prepare.outputs.test_res }}`
            - **SonarQube:** ${{ inputs.sonar_status }}
            [ğŸ”— PR ë°”ë¡œê°€ê¸°](${{ github.event.pull_request.html_url }})